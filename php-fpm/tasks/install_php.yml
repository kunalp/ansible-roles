---

- name: update apt cache
  apt: update_cache=yes cache_valid_time=3600

- name: Install PHP
  apt: name={{ item }} state=present
  with_items:
    - php5-fpm
    - php5-gd
    - php5-mcrypt
    - php5-cli
    - php5-curl

- name: Write php.ini (FPM)
  action: template src=php-fpm.ini dest=/etc/php5/fpm/php.ini
  notify:
    - php5-fpm-restart

- name: Write php.ini (CLI)
  action: template src=php-cli.ini dest=/etc/php5/cli/php.ini

- name: Write php-sock.conf
  action: template src=php-sock.conf dest=/etc/nginx/conf.d/php-sock.conf
  notify:
    - nginx-restart

- name: Install git to be used by composer
  apt: name=git state=latest

- name: Install Composer
  shell:
    curl -sS https://getcomposer.org/installer | php && /bin/mv -f /home/vagrant/composer.phar /usr/local/bin/composer
    creates=/usr/local/bin/composer

- name: Update Composer
  sudo: Yes
  shell: composer self-update

- name: Install composer dependencies
  composer: working_dir={{ project_root }} no_dev=no

- name: Add {{ bin_dir }} to PATH
  lineinfile: >
   dest=/etc/environment
   state=present
   backrefs=yes
   regexp='PATH=(["]*)((?!.*?{{ bin_dir }}).*?)(["]*)$'
   line="PATH=\1\2:{{ bin_dir }}\3"
  when: bin_dir is defined

# install optional php extensions
# install xdebug